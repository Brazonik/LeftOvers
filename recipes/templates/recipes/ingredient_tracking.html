{% extends "recipes/base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">My Ingredients</h4>
                </div>
                <div class="card-body">
                    {% if tracked_ingredients %}
                        {% for ingredient in tracked_ingredients %}
                            <div class="ingredient-item p-2 mb-2 border rounded">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-1">{{ ingredient.ingredient_name }}</h5>
                                        <small class="text-muted">Quantity: {{ ingredient.quantity|default:"N/A" }}</small>
                                        {% if ingredient.expiration_date %}
                                            <br>
                                            <small class="text-danger">Expires: {{ ingredient.expiration_date }}</small>
                                        {% endif %}
                                    </div>
                                    <form action="{% url 'remove_tracked_ingredient' ingredient.id %}" method="post" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger btn-sm">√ó</button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No ingredients being tracked.</p>
                    {% endif %}
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">Add Ingredient</h4>
                </div>
                <div class="card-body">
                    <form id="trackIngredientForm" class="needs-validation">
                        <div class="mb-3">
                            <label for="ingredientName" class="form-label">Ingredient Name</label>
                            <input type="text" class="form-control" id="ingredientName" required>
                        </div>
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Quantity (optional)</label>
                            <input type="text" class="form-control" id="quantity">
                        </div>
                        <div class="mb-3">
                            <label for="expirationDate" class="form-label">Expiration Date (optional)</label>
                            <input type="date" class="form-control" id="expirationDate">
                        </div>
                        <button type="submit" class="btn btn-success w-100">Add Ingredient</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Available Recipes</h4>
                    <button id="searchRecipesBtn" class="btn btn-light">Search Recipes</button>
                </div>
                <div class="card-body">
                    <div id="recipeResults">
                        {% if recipes %}
                            {% for recipe in recipes %}
                                <div class="recipe-card mb-4 border rounded p-3">
                                    <h4 class="recipe-title">{{ recipe.title }}</h4>
                                    <div class="recipe-meta text-muted mb-3">
                                        <small>üìù Match: {{ recipe.ingredients_usage_percentage }}% | 
                                        ‚è≤Ô∏è Prep Time: {{ recipe.readyInMinutes|default:"N/A" }} min | 
                                        üë• Serves: {{ recipe.servings|default:"N/A" }}</small>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5>‚úÖ Available Ingredients:</h5>
                                            <ul class="list-unstyled text-success">
                                                {% for ingredient in recipe.used_ingredients %}
                                                    <li>‚Ä¢ {{ ingredient }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h5>‚ùå Missing Ingredients:</h5>
                                            <ul class="list-unstyled text-danger">
                                                {% for ingredient in recipe.missing_ingredients %}
                                                    <li>‚Ä¢ {{ ingredient }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <a href="{{ recipe.url }}" target="_blank" class="btn btn-primary">View Recipe</a>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-info">
                                No recipes found. Try tracking some ingredients and searching again.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.ingredient-item {
    background-color: #f8f9fa;
    transition: all 0.2s ease;
}

.ingredient-item:hover {
    background-color: #e9ecef;
}

.recipe-card {
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.recipe-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transform: translateY(-2px);
}

.recipe-meta {
    font-size: 0.9rem;
}
</style>

<script>
    document.getElementById('searchRecipesBtn').addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = 'Searching...';
        
        fetch("{% url 'scrape_recipes' %}")
            .then(response => response.text())
            .then(html => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const newRecipes = tempDiv.querySelector('#recipeResults');
                document.querySelector('#recipeResults').innerHTML = newRecipes.innerHTML;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error searching for recipes');
            })
            .finally(() => {
                this.disabled = false;
                this.innerHTML = 'Search Recipes';
            });
            {% if error_message %}
    <div class="alert alert-warning">
        {{ error_message }}
    </div>
{% endif %}
    });

document.getElementById('trackIngredientForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    let data = {
        ingredient_name: document.getElementById('ingredientName').value,
        quantity: document.getElementById('quantity').value,
        expiration_date: document.getElementById('expirationDate').value
    };

    fetch("{% url 'track_ingredient' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Error adding ingredient');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding ingredient');
    });
});
</script>
{% endblock %}