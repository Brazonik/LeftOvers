{% extends "recipes/base.html" %}
{% block content %}
<div class="container mt-4">
    <!-- Add Ingredient Form -->
    <div class="card mb-4">
        <div class="card-body">
            <h3 class="text-danger mb-3">Add New Ingredient</h3>
            <form id="trackIngredientForm">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="ingredientName" class="form-label">Ingredient Name</label>
                        <input type="text" class="form-control" id="ingredientName" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="quantity" class="form-label">Quantity</label>
                        <input type="text" class="form-control" id="quantity">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="expirationDate" class="form-label">Expiration Date</label>
                        <input type="date" class="form-control" id="expirationDate">
                    </div>
                </div>
                <button type="submit" class="btn btn-danger">Add Ingredient</button>
            </form>
        </div>
    </div>

    <!-- Tracked Ingredients -->
    <h2 class="text-danger mb-4">Your Tracked Ingredients</h2>
    <div class="row mb-4">
        {% for ingredient in tracked_ingredients %}
            <div class="col-md-3 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">{{ ingredient.ingredient_name }}</h5>
                        {% if ingredient.quantity %}
                            <p class="card-text">Quantity: {{ ingredient.quantity }}</p>
                        {% endif %}
                        {% if ingredient.expiration_date %}
                            <p class="card-text">Expires: {{ ingredient.expiration_date }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col">
                <div class="alert alert-info">
                    No ingredients tracked yet. Add some above!
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Matching Recipes -->
    <h2 class="text-danger mb-4">
        Matching Recipes 
        {% if perfect_matches %}({{ perfect_matches }} perfect matches){% endif %}
    </h2>
    <div class="row">
        {% for match in matched_recipes %}
            <div class="col-md-4 mb-4">
                <div class="card h-100 {% if match.is_perfect_match %}border-success{% endif %}">
                    <div class="card-body">
                        <h5 class="card-title">{{ match.name }}</h5>
                        <p class="card-text">
                            Match: {{ match.match_percentage }}%
                            {% if match.is_perfect_match %}
                                <span class="badge bg-success">Perfect Match!</span>
                            {% endif %}
                        </p>
                        
                        <h6>Matching Ingredients:</h6>
                        <ul class="list-unstyled">
                            {% for ing in match.matching_ingredients %}
                                <li class="text-success">âœ“ {{ ing }}</li>
                            {% endfor %}
                        </ul>
                        
                        {% if match.missing_ingredients %}
                            <h6>Additional Ingredients Needed:</h6>
                            <ul class="list-unstyled">
                                {% for ing in match.missing_ingredients %}
                                    <li class="text-warning">+ {{ ing }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        
                        {% if match.is_dataset %}
                            <a href="{% url 'dataset-recipe-detail' match.recipe.pk %}" 
                               class="btn btn-outline-danger mt-2">View Recipe</a>
                        {% else %}
                            <a href="{% url 'recipes-detail' match.recipe.pk %}" 
                               class="btn btn-outline-danger mt-2">View Recipe</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col">
                <div class="alert alert-info">
                    No matching recipes found. Try adding more ingredients to your tracking list!
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Pagination Section -->
{% if matched_recipes.has_other_pages %}
<div style="display: flex; justify-content: center; align-items: center; margin: 30px 0; margin-left: 270px;">
    {% if matched_recipes.has_previous %}
        <a href="?page=1{% if query %}&q={{ query }}{% endif %}" 
           style="color: #ff6347; padding: 8px 16px; text-decoration: none; background-color: white; border: 1px solid #ff6347; margin: 0 4px; border-radius: 4px; transition: all 0.2s ease;">
            First
        </a>
        <a href="?page={{ matched_recipes.previous_page_number }}{% if query %}&q={{ query }}{% endif %}"
           style="color: #ff6347; padding: 8px 16px; text-decoration: none; background-color: white; border: 1px solid #ff6347; margin: 0 4px; border-radius: 4px; transition: all 0.2s ease;">
            Previous
        </a>
    {% endif %}

    <span style="margin: 0 15px; color: #666;">
        Page {{ matched_recipes.number }} of {{ matched_recipes.paginator.num_pages }}
    </span>

    {% if matched_recipes.has_next %}
        <a href="?page={{ matched_recipes.next_page_number }}{% if query %}&q={{ query }}{% endif %}"
           style="color: #ff6347; padding: 8px 16px; text-decoration: none; background-color: white; border: 1px solid #ff6347; margin: 0 4px; border-radius: 4px; transition: all 0.2s ease;">
            Next
        </a>
        <a href="?page={{ matched_recipes.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}"
           style="color: #ff6347; padding: 8px 16px; text-decoration: none; background-color: white; border: 1px solid #ff6347; margin: 0 4px; border-radius: 4px; transition: all 0.2s ease;">
            Last
        </a>
    {% endif %}
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('trackIngredientForm');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('Form submitted');
        
        const formData = {
            ingredient_name: document.getElementById('ingredientName').value,
            quantity: document.getElementById('quantity').value,
            expiration_date: document.getElementById('expirationDate').value
        };
        
        console.log('Sending data:', formData);

        fetch("{% url 'track_ingredient' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Error adding ingredient');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding ingredient');
        });
    });
});
</script>
{% endblock %}